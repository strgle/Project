(function(a, c) {    
    a.fn.tree = function(d){
    	var _html = "";
    	if(typeof(d.dataSource)=="undefined"){
    		$.ajax({type: 'POST',
        		async: false,
        		dataType:"json",
        		data:d.data,
        		url:d.url,
        		success: function(data){
        			_html = _getTreeHtml(data,d.leafNode);
        		}
        	});
    	}else{
    		var _html = _getTreeHtml(d.dataSource,d.leafNode);
    		
    	}
    	a(this).html(_html);
    	var _that = a(this);
    	_that.off("click", ".tree-item");
    	_that.on("click", ".tree-item",function(){
    		if(d.selectItem){
    			$(this).parents(".tree").find(".tree-selected").removeClass("tree-selected");
    			$(this).addClass("tree-selected");
    			d.selectItem($(this).children("div").data());
    		}
    	});
    	_that.off("click", ".tree-folder-header i");
    	_that.on("click", ".tree-folder-header i",function(){
    		//展开子节点
    		var ii = $(this);
    		var folderName = $(this).parent().children("div");
    		if($(folderName).data("loaded")=="no"){
    			var params = d.loadChildren($(folderName).data());
    			_loadChildren(folderName,params);
    			$(folderName).data("loaded","yes");
    		}
    		var folderContent = $(this).parent().next(".tree-folder-content");
    		if($(ii).hasClass('fa-folder-open')){
    			$(ii).removeClass('fa-folder-open');
    			$(ii).addClass('fa-folder');
    			$(folderContent).hide();
    		}else{
    			//收起同级别的其它展开菜单
    			var sibl = $(this).parent().parent().siblings().children(".tree-folder-header").find($(".fa-folder-open"));
    			for(var k=0;k<sibl.length;k++){
    				$(sibl[k]).removeClass('fa-folder-open');
					$(sibl[k]).addClass('fa-folder');
					$(sibl[k]).parent().next(".tree-folder-content").hide();
    			}
    			
    			$(ii).removeClass('fa-folder');
    			$(ii).addClass('fa-folder-open');
    			$(folderContent).show();
    		}
    		return false;
    	});
    	
    	_that.off("click", ".tree-folder-header");
    	_that.on("click", ".tree-folder-header",function(){
    		if($(this).children("i").hasClass('fa-folder')){
    			$(this).children("i").click();
    		}
    		
    		if(d.selectFolder){
    			$(this).parents(".tree").find(".tree-selected").removeClass("tree-selected");
    			$(this).addClass("tree-selected");
    			d.selectFolder($(this).children("div").data());
    		}
    	});
    };
})(window.jQuery);

function _getTreeHtml(data,leafNode){
	
	if(typeof(leafNode)=="undefined"){
		leafNode="item";
	}
	
	var _html = "";
	for(var j = 0; j < data.length; j++) {
		var _elem = data[j];
		
		if(_elem.type!=undefined && _elem.type != leafNode) {
			var _preFolder = '<div class="tree-folder" style="display: block;">';
			var _header = '<div class="tree-folder-header" ><i class="fa fa-folder"></i><div class="tree-folder-name"';
			for(var key in _elem){
				if(key=="children"||key=="loaded"){
					continue;
				}else{
					_header = _header+' data-'+key+' = "'+_elem[key]+'"';
				}
			}
			
			if(_elem.children== undefined || _elem.children.length == 0){
				_header = _header+' data-loaded="no"';
			}
			
			var _header = _header+'>'+_elem.title+'</div></div>';
			var _preContent = '<div class="tree-folder-content" style="display:none;">';
			
			_html  = _html + _preFolder+_header+_preContent;
			
			if(_elem.children !== undefined && _elem.children.length > 0){
				_html = _html + _getTreeHtml(_elem.children,leafNode);
			}
			var _endContent = '</div>';
		
			var _endFolder = '</div>';
			_html = _html+_endContent+_endFolder;
		}else{
			_html = _html + '<div class="tree-item" style="white-space:nowrap;"><div class="tree-item-name" ';
			
			for(var key in _elem){
				if(key=="children"){
					continue;
				}else{
					_html = _html+' data-'+key+' = "'+_elem[key]+'"';
				}
			}
			
			_html = _html + '><i class="fa-leaf fa"></i>'+_elem.title+'</div></div>';
		}
	}
	return _html;
}

function _loadChildren(obj,params){
	$.ajax({type: 'POST',
		async: false,
		dataType:"json",
		data:params.data,
		url:params.url,
		success: function(data){
			var _html = _getTreeHtml(data);
			$(obj).parent().next(".tree-folder-content").html(_html);
		}
	});
	
}
